{% extends "base.html" %}

{% block file_upload %}
  {% if request.user.is_authenticated %}
    <!-- styling -->
    <style media="screen">
      .fileDrag {
      	font-weight: bold;
      	text-align: center;
      	padding: 1em 0;
      	margin: 1em 0;
      	border: 2px dashed #555;
      	border-radius: 7px;
      }

      .fileInput {
        display: none;
      }

      .fileLink {
        text-decoration: underline;
        color: black;
        cursor: pointer;
      }

      .fileLink:hover {
        color: #555;
      }

      .filename {
        display: inline-block;
        font-size: 18px;
      }

      .deleteButton {
        margin-left: 200px;
      }
    </style>

    <!-- file html -->
    <form method="post" enctype="multipart/form-data" onkeydown="prevent_default(event)">
      {% csrf_token %}
      <fieldset>
        <!-- input for textbooks (multiple .txt files) -->
        <div id="textbookForm">
            <legend>Textbook upload</legend>
            <label for="textbookfile">Files to Upload (only <b>.txt</b> files accepted):</label>
            <div id="textbookNames">
            </div>
            <input type="file" id="textbookInput0" class="fileInput" name="textbook_file" onchange="handleTextbookFile(event)" />
            <div id="textbookDrop" class="fileDrag" ondrop="onDropHandle(event, 1)" ondragover="onDragOverHandle(event, 1)" ondragleave="onDragLeaveHandle(event, 1)">
              <a href="" id="textbookUploadLink" class="fileLink" onclick="triggerInput(event, 'textbookInput0')">Select</a> or drop <b>.txt</b> files here
            </div>
        </div>
        <!-- input for articles (one zip file only) -->
        <div id="articleForm">
          <legend>Article Upload</legend>
          <label for="articleFile">File to upload (only <b>.zip</b> file accepted):</label>
          <div id="articleName">
          </div>
          <input type="file" id="articleInput" class="fileInput" name="article_file" onchange="handleArticleFile()" />
          <div id="articleDrop" class="fileDrag" ondrop="onDropHandle(event, 0)" ondragover="onDragOverHandle(event, 0)" ondragleave="onDragLeaveHandle(event, 0)">
            <a href="" id="uploadLink" class="fileLink" onclick="triggerInput(event, 'articleInput')">Select</a> or drop <b>.zip</b> file here
          </div>
        </div>
        <!-- input for keywords (multiple strings) -->
        <div id="keywordForm">

        </div>
        <!-- submit -->
        <div id="submitbutton">
        	<button type="submit">Upload Files</button>
        </div>
      </fieldset>
    </form>

    <!-- javascript -->
    <script>

      // TODO
      function onDropHandle(event, isTextbookDrop) {
        event.preventDefault();
        if (isTextbookDrop) {

        } else {
          var files = event.dataTransfer.files;
          if (files.length > 0) {
            var inputElement = document.getElementById("articleInput");
            inputElement.files = files;
            inputElement.onchange();
          }
        }
      }

      // when a file is dragged over drop-box, change style to alert user
      function onDragOverHandle(event, isTextbookDrop) {
        event.preventDefault();
        var dropDiv;
        if (isTextbookDrop) {
          dropDiv = document.getElementById("textbookDrop");
        } else {
          dropDiv = document.getElementById("articleDrop");
        }
        dropDiv.style.cssText = "border-style: solid; box-shadow: inset 0 3px 4px #888;";
      }

      // when a file is leaving drop-box, change style to alert user
      function onDragLeaveHandle(event, isTextbookDrop) {
        if (isTextbookDrop) {
          dropDiv = document.getElementById("textbookDrop");
        } else {
          dropDiv = document.getElementById("articleDrop");
        }
        dropDiv.style.cssText = "border-style: dashed; box-shadow: 0;";
      }

      function triggerInput(event, inputID) {
        event.preventDefault();
        var inputElement = document.getElementById(inputID);
        inputElement.click();
      }

      function handleTextbookFile(event) {
        var inputElement = event.target;
        var idString = inputElement.id.slice(-1);
        var id = Number(idString);
        var filename = getFilename(inputElement);
        var divNameElement = document.getElementById("textbookNames");
        var nameElement = createNameElement("textbookName" + id, filename);
        var brElement = createBrElement("textbookBr" + id);
        var buttonElement = createButton("textbookDelete" + id);
        divNameElement.appendChild(nameElement);
        divNameElement.appendChild(brElement);
        divNameElement.appendChild(buttonElement);
        var brElement = createBrElement("textbookBr" + id);
        divNameElement.appendChild(brElement);
        var newID = id + 1;
        var newInputElement = document.createElement("INPUT");
        newInputElement.setAttribute("type", "file");
        newInputElement.setAttribute("id", "textbookInput" + newID);
        newInputElement.setAttribute("class", "fileInput");
        newInputElement.setAttribute("name", "textbook_file");
        newInputElement.setAttribute("onchange", "handleTextbookFile(event)");
        inputElement.insertAdjacentElement("afterend", newInputElement);
        var textbookLinkElement = document.getElementById("textbookUploadLink");
        textbookLinkElement.removeAttribute("onclick");
        textbookLinkElement.setAttribute("onclick", "triggerInput(event, 'textbookInput" + newID + "')");
      }

      function handleArticleFile() {
        var articleInput = document.getElementById("articleInput");
        var articleDrop = document.getElementById("articleDrop");
        articleDrop.style.cssText = "display: none;";
        var filename = getFilename(articleInput);
        var divNameElement = document.getElementById("articleName");
        var nameElement = createNameElement("articleZipName", filename);
        var brElement = createBrElement("articleBr");
        var buttonElement = createButton("articleDeleteButton", "removeArticle()");
        divNameElement.appendChild(nameElement);
        divNameElement.appendChild(brElement);
        divNameElement.appendChild(buttonElement);
      }

      function getFilename(inputElement) {
        var filename = inputElement.value;
        filename = filename.replace(/.*[\/\\]/, '');
        return filename;
      }

      function createNameElement(nameElementId, textContent) {
        var nameElement = document.createElement("P");
        nameElement.setAttribute("id", nameElementId);
        nameElement.setAttribute("class", "filename");
        nameElement.innerHTML = textContent;
        return nameElement;
      }

      function createBrElement(brID) {
        var brElement = document.createElement("BR");
        brElement.setAttribute("id", brID);
        return brElement;
      }

      function createButton(buttonID, onclickFunc) {
        var buttonElement = document.createElement("BUTTON");
        buttonElement.setAttribute("id", buttonID);
        buttonElement.setAttribute("class", "deleteButton");
        buttonElement.setAttribute("onclick", onclickFunc);
        buttonElement.innerHTML = "Remove";
        return buttonElement;
      }

      function removeArticle() {
        var divNameElement = document.getElementById("articleName");
        var nameElement = document.getElementById("articleZipName");
        var brElement = document.getElementById("articleBr");
        var buttonElement = document.getElementById("articleDeleteButton");
        divNameElement.removeChild(nameElement);
        divNameElement.removeChild(brElement);
        divNameElement.removeChild(buttonElement);
        var articleDrop = document.getElementById("articleDrop");
        articleDrop.style.cssText = "display: default;";
      }
    </script>
  {% endif %}
{% endblock file_upload %}
