{% extends "base.html" %}

{% block file_upload %}
  {% if request.user.is_authenticated %}
    <!-- styling -->
    <style media="screen">
      .fileDrag {
      	font-weight: bold;
      	text-align: center;
      	padding: 1em 0;
      	margin: 1em 0;
      	border: 2px dashed #555;
      	border-radius: 7px;
      }

      .fileInput {
        display: none;
      }

      .fileLink {
        text-decoration: underline;
        color: black;
        cursor: pointer;
      }

      .fileLink:hover {
        color: #555;
      }

      .filename {
        display: inline-block;
        font-size: 18px;
      }

      .deleteButton {
        margin-left: 200px;
      }
    </style>

    <!-- file html -->
    <form method="post" enctype="multipart/form-data" onkeydown="prevent_default(event)">
      {% csrf_token %}
      <fieldset>
        <!-- input for textbooks (multiple .txt files) -->
        <div id="textbookForm">
            <legend>Textbook upload</legend>
            <label for="textbookfile">Files to Upload (only <b>.txt</b> files accepted):</label>
            <div id="textbookNames">
            </div>
            <input type="file" id="textbookInput0" class="fileInput" name="textbook_file" onchange="handleFile('textbookInput0', true)" />
            <div id="textbookDrop" class="fileDrag" ondrop="onDropHandle(event, 1, 0)" ondragover="toggleBoxStyle(event, true, true)" ondragleave="toggleBoxStyle(event, true, false)">
              <a href="" id="textbookUploadLink" class="fileLink" onclick="triggerInput(event, 'textbookInput0')">Select</a> or drop <b>.txt</b> files here
            </div>
        </div>
        <!-- input for articles (one zip file only) -->
        <div id="articleForm">
          <legend>Article Upload</legend>
          <label for="articleFile">File to upload (only <b>.zip</b> file accepted):</label>
          <div id="articleName">
          </div>
          <input type="file" id="articleInput" class="fileInput" name="article_file" onchange="handleFile('articleInput', false)" />
          <div id="articleDrop" class="fileDrag" ondrop="onDropHandle(event, 0, 0)" ondragover="toggleBoxStyle(event, false, true)" ondragleave="toggleBoxStyle(event, false, false)">
            <a href="" id="uploadLink" class="fileLink" onclick="triggerInput(event, 'articleInput')">Select</a> or drop <b>.zip</b> file here
          </div>
        </div>
        <!-- input for keywords (multiple strings) -->
        <div id="keywordForm">

        </div>
        <!-- submit -->
        <div id="submitbutton">
        	<button type="submit">Upload Files</button>
        </div>
      </fieldset>
    </form>

    <!-- javascript -->
    <script>
      // TODO
      function onDropHandle(event, isTextbookDrop, latestID) {
        event.preventDefault();
        var files = event.dataTransfer.files;
        if (files != null && files.length > 0) {
          if (isTextbookDrop) {
            for (var i = 0; i < files.length; i++) {
              file = files[i];
              var newFiles = [];
              newFiles.push(file);
              var inputElement = document.getElementById("textbookInput" + latestID);
              inputElement.files = newFiles;
              inputElement.onchange();
              latestID++;
            }
          } else {
              var inputElement = document.getElementById("articleInput");
              inputElement.files = files;
              inputElement.onchange();
          }
        }
      }

      // Change style of drop box when a file dragged over it
      function toggleBoxStyle(event, isTextbookDrop, isInBox) {
        event.preventDefault();
        var dropDiv;
        if (isTextbookDrop) dropDiv = document.getElementById("textbookDrop");
        else dropDiv = document.getElementById("articleDrop");
        if (isInBox) dropDiv.style.cssText = "border-style: solid; box-shadow: inset 0 3px 4px #888;";
        else dropDiv.style.cssText = "border-style: dashed; box-shadow: 0;";
      }

      // Trigger the onclick event of an input element
      function triggerInput(event, inputID) {
        event.preventDefault();
        document.getElementById(inputID).click();
      }

      // TODO 
      function handleFile(inputElementID, isTextbook) {
        var inputElement = document.getElementById(inputElementID);
        var id;
        var filename = getFilename(inputElement);
        var divNameElement;
        var nameAttributes = {"class": "filename"};
        var brAttributes = {};
        var removeFunction = "removeFile(event.target, '";
        var buttonAttributes = {"class": "deleteButton"};
        if (isTextbook) {
          id = Number(inputElement.id.slice(-1));
          divNameElement = document.getElementById("textbookNames");
          nameAttributes["id"] = "textbookName" + id;
          brAttributes["id"] = "textbookBr" + id;
          removeFunction += "textbookNames', 'textbookName" + id + "', 'textbookBr" + id + "', true)";
          buttonAttributes["id"] = "textbookDelete" + id;
          var newID = id + 1;
          var newInputAttributes = {"type": "file", "id": "textbookInput" + newID, "class": "fileInput", "name": "textbook_file", "onchange": "handleFile('textbookInput" + newID + "', true)"};
          inputElement.insertAdjacentElement("afterend", createElement("INPUT", "", newInputAttributes));
          document.getElementById("textbookUploadLink").setAttribute("onclick", "triggerInput(event, 'textbookInput" + newID + "')");
          document.getElementById("textbookDrop").setAttribute("ondrop", "onDropHandle(event, 1, " + newID + ")");
        } else {
          document.getElementById("articleDrop").style.cssText = "display: none;";
          divNameElement = document.getElementById("articleName");
          nameAttributes["id"] = "articleZipName";
          brAttributes["id"] = "articleBr";
          removeFunction += "articleName', 'articleZipName', 'articleBr', false)";
          buttonAttributes["id"] = "articleDeleteButton";
        }
        buttonAttributes["onclick"] = removeFunction;
        divNameElement.appendChild(createElement("P", filename, nameAttributes));
        divNameElement.appendChild(createElement("BR", "", brAttributes));
        divNameElement.appendChild(createElement("BUTTON", "Remove", buttonAttributes));
        if (isTextbook) {
          divNameElement.appendChild(createElement("BR", "", brAttributes));
        }
      }

      // Get the filename of a file in a DOM element
      function getFilename(inputElement) {
        var filename = inputElement.value;
        filename = filename.replace(/.*[\/\\]/, '');
        return filename;
      }

      // Create a DOM element with given attributes
      function createElement(elementType, innerHTML, attributes) {
        var element = document.createElement(elementType);
        if (innerHTML) element.innerHTML = innerHTML;
        for (const [key, value] of Object.entries(attributes)) element.setAttribute(key, value);
        return element;
      }

      // Remove file and its respective p, br, and button elements
      function removeFile(buttonElement, divID, nameID, brID, isTextbook) {
        var divNameElement = document.getElementById(divID);
        divNameElement.removeChild(document.getElementById(nameID));
        divNameElement.removeChild(document.getElementById(brID));
        divNameElement.removeChild(buttonElement);
        if (isTextbook) divNameElement.removeChild(document.getElementById(brID));
        else document.getElementById("articleDrop").style.cssText = "display: default;";
      }
    </script>
  {% endif %}
{% endblock file_upload %}
